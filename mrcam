#!/usr/bin/python3

import sys
import numpy as np
import numpysane as nps
from fltk import *
from Fl_Gl_Image_Widget import Fl_Gl_Image_Widget
import mrcal
import mrcam


period = 1.0


class Fl_Gl_Image_Widget_Derived(Fl_Gl_Image_Widget):
    def handle(self, event):
        if event == FL_MOVE:
            try:
                q = self.map_pixel_image_from_viewport( (Fl.event_x(),Fl.event_y()), )
                status_widget.value(f"{q[0]:.1f},{q[1]:.1f}")
            except:
                status_widget.value("")
            # fall through to let parent handlers run

        return super().handle(event)


window        = Fl_Window(800, 600, "mrcam stream")
group         = Fl_Group(0,0,800,580)
image_widget  = Fl_Gl_Image_Widget_Derived(0,  0, 800,580,
                                           # Need to disable this for my i915 hardware
                                           double_buffered = False)
group.end()
status_widget = Fl_Output(0, 580, 800, 20)
window.resizable(group)
window.end()
window.show()


# try block needed to avoid potential crashes:
#   https://sourceforge.net/p/pyfltk/mailman/pyfltk-user/thread/875xx5ncgp.fsf%40secretsauce.net/#msg58754407
try:
    c = mrcam.camera()
except Exception as e:
    window.hide()
    raise e






def callback_image_ready(fd):
    frame = c.requested_image()

    image        = frame['image']
    timestamp_us = frame['timestamp_us']

    if image is not None:

        if image.itemsize > 1:
            image = mrcal.apply_color_map(image)

        image_widget.update_image(image_data = image)

    else:
        print("Error capturing the image. I will try again",
              file=sys.stder)

    Fl.add_timeout(period, update)

def update(*args):

    # try block needed to avoid potential crashes:
    #   https://sourceforge.net/p/pyfltk/mailman/pyfltk-user/thread/875xx5ncgp.fsf%40secretsauce.net/#msg58754407
    try:
        c.request()
    except Exception as e:
        window.hide()
        raise e




Fl.add_fd( c.fd_image_ready,
           callback_image_ready )

update()

Fl.run()
